<!DOCTYPE html>
<html lang="ja">
 <head>
    <meta charset='UTF-8'>
	<!-- preload -->
	<script>
		if ( location.pathname.startsWith('/page/') && location.pathname.match( /^[a-zA-Z0-9-0_\.\-\/]+$/ ) ){
			console.log('start preload')
			const preloadLink = document.createElement("link")
			preloadLink.href = 'https://static.katio.net/markdown/' + location.pathname.slice(6) + '.md'
			preloadLink.rel = "preload"
			preloadLink.as = "fetch"
			preloadLink.setAttribute('crossorigin','anonymous')
			document.head.appendChild(preloadLink)
		}
	</script>
	<!-- /preload -->
    <link rel="preconnect" href="https://static.katio.net/">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com/">
    <link rel="preconnect" href="https://cdn.honokak.osaka/">
    <link rel="dns-prefetch" href="https://static.katio.net/">
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com/">
    <link rel="dns-prefetch" href="https://cdn.honokak.osaka/">

    <link rel="stylesheet" href='https://cdn.honokak.osaka/honoka/4.3.1/css/bootstrap.min.css'>
    <!--link rel="stylesheet" href="/github-markdown.css"-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/3.0.1/github-markdown.min.css">
    <link rel="stylesheet" href='/reset.css'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/styles/solarized-dark.min.css" integrity="sha384-p6WZvQLdHPn3qN+qHxW8HTPV11ZECxUCxol/Rg+glNgBrkyTUwNiPIrXE2EESD3z" crossorigin="anonymous">
    <link rel="stylesheet" href='/main.css'>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.6.1/marked.min.js" integrity="sha384-EiOGSCEMZcrL0lbddeRRJEF8+qWFNoCH1guk5GrDVcojQEy4XZMchqvucM+f1WCG" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/highlight.min.js" integrity="sha384-Lq4dkOUVSNElT8uHCChL3Wlg1H2PWo8qxHqROqOMeVSHAtBe0lWY8KT+yJwHNQ2Q" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/emoji-toolkit@5.0.5/lib/js/joypixels.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/emoji-toolkit@5.0.5/extras/css/joypixels.min.css">
    <script src="https://unpkg.com/js-yaml@3.10.0/dist/js-yaml.js"></script>
    <script src="https://dworthen.github.io/js-yaml-front-matter/js/yamlFront.js"></script>

    <meta content='width=device-width, initial-scale=1, shrink-to-fit=no' name='viewport'>

    <meta name='author' content='@onokatio_'>
    <meta name='application-name' content="おのかちお's blog">
    <meta name='description' content='取得に失敗しました'>
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@onokatio_">
    <meta name="twitter:creator" content="@onokatio_">
    <meta property="og:title" content="取得に失敗しました - おのかちお's blog">
    <meta property="og:description" content="取得に失敗しました">
    <meta property="og:type" content="artcle">
    <meta property="og:url" content="https://blog.katio.net/">
    <meta property="og:image" content="https://static.katio.net/image/katio.jpg">
    <meta property="og:site_name" content="おのかちお's blog">

    <meta name="google-site-verification" content="86HJNXgtgHoaF8PlmtzVUIic7r18GLYtEIQZJLt2mN4" />

    <link rel="icon" href="/favicon.ico">
    <title>Loading... - おのかちお's blog</title>

  </head>
  <body>
	<div class="container">
			<p id="markdown" class="markdown-body"></p>
			<hr>
			<p class="text-right"><a id="editgithub" href="#">Pull Request this page on github</a></p>
			<p class="text-left"><a id='gobacklink' href='/'>Go home</a></p>
	</div>

	<script>
		const renderer = new marked.Renderer()

		marked.setOptions({
			renderer: renderer,
			langPrefix: 'hljs ',
			highlight: (code) => hljs.highlightAuto(code).value,
		})

		const smoothJump = (event) => {
			event.preventDefault()
			event.stopPropagation()
			history.pushState(null, null, event.target.pathname)
			UpdatePageFromUrl()
			return false;
		}

		const hashChangeEvent = () => {
			if (location.pathname === "/" && location.hash.startsWith('#/page/')) {
				filename = location.hash.slice(7)
				location.href = "/page/" + filename
			}
		}
		hashChangeEvent()


		const RenderIndex = () => {
			return fetch('https://static.katio.net/dynamic/markdownlist')
				.then( (response) => response.json() )
				.then( (json) => {

					document.getElementById("editgithub").setAttribute("href", "https://github.com/onokatio-blog/blog")
					document.getElementById("editgithub").textContent = 'Pull Request this site on github'
					document.getElementById("markdown").textContent = ''

					const header = document.createElement('h1')
					header.textContent = "おのかちお's blog"

					const articleList = document.createElement('div')
					articleList.className = 'd-flex flex-wrap'
					articleList.id = 'articleList'
					document.getElementById("markdown").appendChild(header)
					document.getElementById("markdown").appendChild(articleList)


					json = json.filter( (contentAndFilename) => contentAndFilename.filename !== '404.md' )
					json.forEach( ({filename,title,summary}) => {

						const card = createCard(filename,title,summary)
						document.getElementById("articleList").appendChild(card)

						/*
						const preloadLink = document.createElement("link")
						preloadLink.href = 'https://static.katio.net/markdown/' + filename
						preloadLink.rel = "preload"
						preloadLink.as = "fetch"
						preloadLink.setAttribute('crossorigin','anonymous')
						document.head.appendChild(preloadLink)
						*/

					})

					document.querySelector("meta[name='description']").setAttribute('content', '記事一覧')
					document.querySelector("meta[property='og:description']").setAttribute('content', '記事一覧')
					document.title = "記事一覧 - おのかちお's blog"
					document.querySelector("meta[property='og:title']").setAttribute('content', "記事一覧 - おのかちお's blog")

					return Promise.resolve()
				})
		}
		const RenderMarkdown = (filename) => {
				return fetch('https://static.katio.net/' + filename)
					.then( (response) => {
						if( response.ok !== true ) {
							return fetch('https://static.katio.net/markdown/404.md')
								.then( (response) => response.text() )
						} else {
							return response.text()
						}
					})
					.then ( (text) => {
						metadata = yamlFront.safeLoadFront(text)
						content = metadata.__content
						html = marked(content, { renderer: renderer })
						document.getElementById("markdown").textContent = ''
						document.getElementById("markdown").insertAdjacentHTML('afterbegin',html)

						const hackmd_title_regex = /^\n*(.+)\n=+/
						const markdown_title_regex = /^\n*# (.+)\n/

						summary = content.replace(hackmd_title_regex,'') // remove (title \n ===)
							.replace(markdown_title_regex,'')          // remove (# title\n)
							.replace(/\n#+ /g,'\n')         // remove markdown sharp
							.replace(/`/g,'')               // remove markdown back quote`
							.replace(/^ +- /g,'')           // remove markdown hyphen
							.replace(/\!?\[.*\]\((.+)\)/g,'$1') // remove markdown link
							.replace(/:[a-zA-Z]+:/g,'')     // remove emoji
							.replace(/\n/g,' ')             // replace newline to space
							.replace(/^ +/,'')              // delete prefix space
							.slice(0,100)


						document.querySelector("meta[name='description']").setAttribute('content', summary)
						document.querySelector("meta[property='og:description']").setAttribute('content', summary)

						if( metadata.title !== undefined ){
							title = metadata.title
						}else if( ( result = content.match(hackmd_title_regex) ) !== null){
							title = result[0].replace(hackmd_title_regex,'$1')
						}else if( ( result = content.match(markdown_title_regex)) !== null){
							title = result[0].replace(markdown_title_regex,'$1')
						}else{
							title = ''
						}

						document.title = title + " - おのかちお's blog"
						document.querySelector("meta[property='og:title']").setAttribute('content', title + " - おのかちお's blog")
					})
		}
		const isValidFileName = filename => ! filename.match( /^[a-zA-Z0-9-0_\.\-\/]+$/)

		const UpdatePageFromUrl = () => {
			pathname = location.pathname
			if ( pathname.startsWith('/page/') ) {
				filename = 'markdown/' + location.pathname.slice(6) + '.md'
				if ( isValidFileName(filename) ) filename = 'markdown/404.md';
			} else if ( pathname === '/') {
				filename = 'markdown/index.md'
			} else {
				filename = 'markdown/404.md'
			}

			document.getElementById("editgithub").setAttribute("href", "https://github.com/onokatio-blog/blog/blob/master/" + filename)
			document.getElementById("markdown").textContent = 'loading ...'

			const markdownPromise = pathname === '/' ? RenderIndex()  : RenderMarkdown(filename)

			markdownPromise.then( () => {
				document.getElementById('markdown').innerHTML = joypixels.shortnameToUnicode(container.innerHTML)

				Array.prototype.forEach.call(container.getElementsByTagName('a'), (element) => {
					if( element.pathname.startsWith('/page/') || element.pathname === '/'){
						element.addEventListener('click', smoothJump )
					}
				})

			})

		}
		const createCard = (filename,title,summary) => {
			const articleTitle = document.createElement("h5")
			articleTitle.className = "card-title"
			articleTitle.textContent = title

			const articleSummary = document.createElement("p")
			articleSummary.className = "card-text"
			articleSummary.textContent = summary + '...'

			const articleLink = document.createElement("a")
			articleLink.className = "card-link"
			articleLink.href = "/page/" + filename.replace(/\.md$/,'')
			articleLink.textContent = "Read more"

			const articleBody = document.createElement("div")
			articleBody.className = "card-body"
			articleBody.appendChild(articleTitle)
			articleBody.appendChild(articleSummary)
			articleBody.appendChild(articleLink)

			const card = document.createElement("div")
			card.className = "card"
			card.appendChild(articleBody)

			return card
		}

		goback = document.getElementById('gobacklink').addEventListener('click', smoothJump )

		window.onhashchange = hashChangeEvent
		window.onpopstate = UpdatePageFromUrl

		UpdatePageFromUrl()

	</script>

	<!-- Bootstrap -->
	<!--
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous" defer></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.bundle.min.js" integrity="sha384-xrRywqdh3PHs8keKZN+8zzc5TX0GRTLCcmivcbNJWm2rs5C8PRhcEn3czEjhAO9o" crossorigin="anonymous" defer></script>
	-->
  </body>
</html>
